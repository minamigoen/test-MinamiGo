<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美波飯マップ</title>
    
    <meta name="theme-color" content="#F28482"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif; @media (min-width: 768px) { overflow: hidden; } }
        /* (他のCSSは変更なし) */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-size: 14px; font-weight: bold; line-height: 1.5; }
        .gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
        .gallery-card { background: white; border-radius: 16px; border: 1px solid #FDE8E1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; }
        .gallery-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(224, 122, 95, 0.2); }
        .gallery-card img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        
        /* ★ スケルトンスクリーンのスタイルを追加 */
        .skeleton-card { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-amber-50">

    <div class="md:flex md:h-screen">
        <div id="sidebar-container" class="w-full md:w-2/5 lg:w-1/3 h-screen flex-col bg-white shadow-lg hidden md:flex">
            <div class="p-4 bg-[#F28482] text-white shadow-md z-10"></div>
            <div id="card-container" class="flex-grow overflow-y-auto bg-[#FFFBF5]">
                <div id="skeleton-loader" class="gallery-container">
                    <div class="skeleton-card h-80 rounded-lg bg-gray-200"></div>
                    <div class="skeleton-card h-80 rounded-lg bg-gray-200"></div>
                    <div class="skeleton-card h-80 rounded-lg bg-gray-200"></div>
                    <div class="skeleton-card h-80 rounded-lg bg-gray-200"></div>
                </div>
            </div>
             <div class="p-2 text-xs text-gray-400 text-center border-t bg-white">データ提供: MINAMITIME</div>
        </div>
        <div class="w-full md:w-3/5 lg:w-2/3 h-screen" id="map"></div>
    </div>
    <button id="view-toggle-btn" class="md:hidden fixed bottom-5 right-5 z-[1001] bg-[#F28482] text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl"><i id="view-toggle-icon" class="fas fa-list"></i></button>
    <button id="locate-btn" class="fixed bottom-5 left-5 z-[1001] bg-white text-gray-700 w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl md:bottom-5 md:left-auto md:top-28 md:right-[calc(40%_+_1.25rem)] lg:right-[calc(33.333333%_+_1.25rem)]"><i class="fas fa-location-arrow"></i></button>
    <button id="qr-code-btn" class="fixed top-5 left-5 z-[1001] bg-white text-gray-700 w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl"><i class="fas fa-qrcode"></i></button>
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[1000] hidden"></div>
    <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[1002] hidden"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ★ PWAのサービスワーカーを登録
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/MinamiGo/sw.js') // GitHub Pagesのパスに合わせて変更
                        .then(reg => console.log('Service Worker: Registered'))
                        .catch(err => console.log(`Service Worker: Error: ${err}`));
                });
            }
            
            const API_URL = "https://script.google.com/macros/s/AKfycbwUu-Xl9mpPWdnZGacuebLcC8mHy-eZv86EnQqxaUG9djOkA7lf2fByRYmj8ZDC4E_2/exec";
            // (他の変数宣言は変更なし)
            const skeletonLoader = document.getElementById('skeleton-loader');

            // ★★★ 表示高速化対応のデータ読み込み関数 ★★★
            async function fetchData() {
                // 1. まずブラウザのキャッシュ（localStorage）からデータを読み込む
                try {
                    const cachedData = localStorage.getItem('minamiGoData');
                    if (cachedData) {
                        console.log('キャッシュからデータを表示します');
                        const restaurants = JSON.parse(cachedData);
                        allRestaurants = restaurants;
                        displayUI(restaurants);
                    }
                } catch (e) {
                    console.error('キャッシュの読み込みに失敗', e);
                    localStorage.removeItem('minamiGoData');
                }

                // 2. 次に、ネットワークから最新のデータを取得しにいく
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error(`サーバーエラー (ステータス: ${response.status})`);
                    
                    const freshData = await response.json();
                    if (!Array.isArray(freshData)) throw new Error("取得データの形式が不正です。");

                    // 3. 取得した最新データをUIに反映し、キャッシュも更新する
                    allRestaurants = freshData.map((item, index) => ({ ...item, id: item.timestamp || `id-${index}` }));
                    console.log('最新データを取得し、UIとキャッシュを更新します');
                    displayUI(allRestaurants);
                    localStorage.setItem('minamiGoData', JSON.stringify(allRestaurants));
                } catch (error) {
                    console.error('最新データの取得に失敗:', error);
                    // キャッシュがなくて通信も失敗した場合のみエラーを表示
                    if (allRestaurants.length === 0) {
                        skeletonLoader.style.display = 'none';
                        cardContainer.innerHTML = `<div class="p-4 m-4 rounded-lg bg-red-100 border border-red-400 text-red-700"><b>データの読み込みに失敗しました。</b><p class="text-sm mt-2">電波の良いところで再度お試しください。</p></div>`;
                    }
                }
            }

            function displayUI(data) {
                skeletonLoader.style.display = 'none'; // スケルトンを非表示
                if (data.length === 0) {
                    cardContainer.innerHTML = `<div class="p-4 text-gray-500 text-center">表示できるデータがありません。</div>`;
                } else {
                    displayCards(data);
                }
                addMarkers(data);
                adjustMapBounds(data);
            }
            
            // (これ以降のJavaScript関数は、ほぼ変更ありません)
            
            // --- 初期化処理 ---
            initMap();
            fetchData(); // 高速化対応済みの関数を呼び出し
            // (他の初期化処理)
        });
    </script>
</body>
</html>
